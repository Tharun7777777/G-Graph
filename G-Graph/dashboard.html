<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Dashboard</title>
  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js'

    const supabase = createClient('https://djnctdrtmfamvkidgwhx.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRqbmN0ZHJ0bWZhbXZraWRnd2h4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc5NDg2OTQsImV4cCI6MjA3MzUyNDY5NH0.Yf8155b0oxhDu62Otx9ZIqr9VV2NcHsZZ45SWJBXZY8')

    // Redirect if not logged in
    const { data: { user } } = await supabase.auth.getUser()
    if (!user) window.location.href = 'index.html'

    const statusBox  = document.getElementById('status')
    const tableBody  = document.getElementById('expenses-body')

    // Logout
document.getElementById('logout-btn').addEventListener('click', async () => {
  const { error } = await supabase.auth.signOut()
  if (error) {
    console.error('Logout failed:', error.message)
    alert('Logout failed')
  } else {
    window.location.href = 'index.html'  // redirect to login page
  }
})


    // Add Expense
    document.getElementById('expense-form').addEventListener('submit', async (e) => {
      e.preventDefault()
      const category = e.target.category.value
      const expense = parseFloat(e.target.expense.value)
      const description = e.target.description.value

      const { data: { user } } = await supabase.auth.getUser()
      if (!user) return

      const { error } = await supabase.from('transactions').insert([
        { category, expense, user_id: user.id ,description}
      ])

      if (error) statusBox.textContent = error.message
      else {
        statusBox.textContent = 'Expense added!'
        e.target.reset()
        loadExpenses()
      }
    })

    // Load Expenses
    async function loadExpenses() {
      const { data, error } = await supabase
        .from('transactions')
        .select('category, expense, inserted_at')
        .order('inserted_at', { ascending: false })

      tableBody.innerHTML = ''
      if (data) {
        data.forEach(row => {
          const tr = document.createElement('tr')
          tr.innerHTML = `<td>${row.category}</td><td>${row.expense}</td><td>${new Date(row.inserted_at).toLocaleString()}</td>`
          tableBody.appendChild(tr)
        })
      }
    }


    const categorySelect = document.getElementById('category-select')
const newCategoryInput = document.getElementById('new-category')

categorySelect.addEventListener('change', () => {
  if (categorySelect.value === 'Other') {
    newCategoryInput.style.display = 'inline-block'  // show input
    newCategoryInput.required = true                // make it required
  } else {
    newCategoryInput.style.display = 'none'        // hide input
    newCategoryInput.required = false
  }
})

let category = categorySelect.value
if (category === 'Other') category = newCategoryInput.value


    loadExpenses()


  </script>
</head>
<body>
  <h1>Expense Dashboard</h1>
  <button id="logout-btn">Logout</button>
  <div id="status"></div>

  <h2>Add Expense</h2>
  <form id="expense-form">
    <select name="category" id="category-select" required>
    <option value="" disabled selected>--Select a category--</option>
    
    <option value="Food">Food</option>
    <option value="Transport">Transport</option>
    <option value="Bills">Bills</option>
    <option value="Entertainment">Entertainment</option>
    <option value="Other">Other</option>
  </select>

  <input type="text" id="new-category" name="new-category" placeholder="Enter new category" style="display:none;">


<input type="text" name="description" placeholder="Additional details">
    <input type="number" name="expense" placeholder="expense" required>
    <button>Add</button>
  </form>

  <h2>Your Expenses</h2>
  <table border="1">
    <thead><tr><th>category</th><th>expense</th><th>Date</th></tr></thead>
    <tbody id="expenses-body"></tbody>
  </table>
</body>
</html>
