<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Dashboard</title>
  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js'

    const supabase = createClient('https://djnctdrtmfamvkidgwhx.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRqbmN0ZHJ0bWZhbXZraWRnd2h4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc5NDg2OTQsImV4cCI6MjA3MzUyNDY5NH0.Yf8155b0oxhDu62Otx9ZIqr9VV2NcHsZZ45SWJBXZY8')

    // Redirect if not logged in
    const { data: { user } } = await supabase.auth.getUser()
    if (!user) window.location.href = 'index.html'

    const statusBox  = document.getElementById('status')
    const tableBody  = document.getElementById('expenses-body')

    // Logout
document.getElementById('logout-btn').addEventListener('click', async () => {
  const { error } = await supabase.auth.signOut()
  if (error) {
    console.error('Logout failed:', error.message)
    alert('Logout failed')
  } else {
    window.location.href = 'index.html'  // redirect to login page
  }
})


    // Add Expense
    document.getElementById('expense-form').addEventListener('submit', async (e) => {
      e.preventDefault()
      const category = e.target.category.value
      const expense = parseFloat(e.target.expense.value)
      const description = e.target.description.value

      const { data: { user } } = await supabase.auth.getUser()
      if (!user) return

      const { error } = await supabase.from('transactions').insert([
        { category, expense, user_id: user.id ,description}
      ])

      if (error) statusBox.textContent = error.message
      else {
        statusBox.textContent = 'Expense added!'
        e.target.reset()
        loadExpenses()
      }
    })

    // Load Expenses
    async function loadExpenses() {
      const { data, error } = await supabase
        .from('transactions')
        .select('category, expense, inserted_at')
        .order('inserted_at', { ascending: false })

      tableBody.innerHTML = ''
      if (data) {
        data.forEach(row => {
          const tr = document.createElement('tr')
          tr.innerHTML = `<td>${row.category}</td><td>${row.expense}</td><td>${new Date(row.inserted_at).toLocaleString()}</td>`
          tableBody.appendChild(tr)
        })
      }
    }


const categorySelect = document.getElementById('category-select')
const newCategoryInput = document.getElementById('new-category')

categorySelect.addEventListener('change', () => {
  if (categorySelect.value === 'Other') {
    newCategoryInput.style.display = 'inline-block'  // show input
    newCategoryInput.required = true                // make it required
  } else {
    newCategoryInput.style.display = 'none'        // hide input
    newCategoryInput.required = false
  }
})

let category = categorySelect.value
if (category === 'Other') category = newCategoryInput.value




// Don't redeclare categorySelect â€” use the one you already have
const summaryCategorySelect = document.getElementById('summary-category-select');

const todayBtn = document.getElementById("today-btn");
const weekBtn = document.getElementById("week-btn");
const monthBtn = document.getElementById("month-btn");

const summaryBody = document.getElementById("summary-body");
const grandTotalEl = document.getElementById("grand-total");

async function loadSummary(period = "total") {
  try {
    const category = summaryCategorySelect.value; // now uses the summary filter
 // use existing variable
    const now = new Date();
    let fromDate = null;

    if (period === "today") {
      fromDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    } else if (period === "week") {
      const day = now.getDay();
      const diff = now.getDate() - day + (day === 0 ? -6 : 1);
      fromDate = new Date(now.getFullYear(), now.getMonth(), diff);
    } else if (period === "month") {
      fromDate = new Date(now.getFullYear(), now.getMonth(), 1);
    }

    let query = supabase.from("transactions").select("*");

    if (category) query = query.eq("category", category);
   if (fromDate) query = query.gte("inserted_at", fromDate.toISOString());


    const { data, error } = await query;
    if (error) throw error;

    const totals = {};
    let grandTotal = 0;

    data.forEach(t => {
      const cat = t.category || "Uncategorized";
      totals[cat] = (totals[cat] || 0) + Number(t.expense);
      grandTotal += Number(t.expense);
    });

    summaryBody.innerHTML = "";
    Object.entries(totals).forEach(([cat, amt]) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${cat}</td><td>${amt.toFixed(2)}</td>`;
      summaryBody.appendChild(tr);
    });

    grandTotalEl.textContent = `Grand Total: ${grandTotal.toFixed(2)}`;
  } catch (err) {
    console.error(err);
    alert("Failed to load summary");
  }
}

// Buttons
todayBtn.addEventListener("click", () => loadSummary("today"));
weekBtn.addEventListener("click", () => loadSummary("week"));
monthBtn.addEventListener("click", () => loadSummary("month"));

// Load total by default
loadSummary("total");
summaryCategorySelect.addEventListener('change', () => loadSummary());


















loadExpenses()


  </script>
</head>
<body>
  <h1>Expense Dashboard</h1>
  <button id="logout-btn">Logout</button>
  <div id="status"></div>

  <h2>Add Expense</h2>
  <form id="expense-form">
    <select name="category" id="category-select" required>
    <option value="" disabled selected>--Select a category--</option>
    
    <option value="Food">Food</option>
    <option value="Transport">Transport</option>
    <option value="Bills">Bills</option>
    <option value="Entertainment">Entertainment</option>
    <option value="Other">Other</option>
  </select>

  <input type="text" id="new-category" name="new-category" placeholder="Enter new category" style="display:none;">


<input type="text" name="description" placeholder="Additional details">
    <input type="number" name="expense" placeholder="expense" required>
    <button>Add</button>
  </form>

  <h2>Your Expenses</h2>
  <table border="1">
    <thead><tr><th>category</th><th>expense</th><th>Date</th></tr></thead>
    <tbody id="expenses-body"></tbody>
  </table>














  <h2>Expense Table</h2>

  <!-- Summary Table Category Filter -->
<label for="summary-category-select">Filter by Category:</label>
<select id="summary-category-select">
  <option value="">All Categories</option>
  <option value="Food">Food</option>
  <option value="Transport">Transport</option>
  <option value="Bills">Bills</option>
  <option value="Entertainment">Entertainment</option>
  <option value="Other">Other</option>
</select>


<!-- Filter buttons -->
<div style="margin-bottom: 1rem;">
  <button id="today-btn">Today</button>
  <button id="week-btn">This Week</button>
  <button id="month-btn">This Month</button>
</div>

<!-- Summary Table -->
<table border="1" cellpadding="6" cellspacing="0">
  <thead>
    <tr>
      <th>Category</th>
      <th>Amount Spent</th>
    </tr>
  </thead>
  <tbody id="summary-body">
    <!-- Filled dynamically by script -->
  </tbody>
</table>

<!-- Grand Total -->
<div id="grand-total" style="margin-top:1rem; font-weight:bold;">
  Grand Total: 0
</div>



</body>
</html>
