<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>User Transaction Dashboard</title>
    <link rel="stylesheet" href="dashboard.css" />

  <!-- GSAP Core -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.13.0/gsap.min.js"></script>

<!-- ScrollTrigger Plugin -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.13.0/ScrollTrigger.min.js"></script>

  <script type="module">

  import { createClient } from 'https://esm.sh/@supabase/supabase-js'



   document.addEventListener("DOMContentLoaded", () => {






  gsap.registerPlugin(ScrollTrigger);

  const isMobile = window.innerWidth <= 700;

  

  // Ensure consistent 3D space for all cards
  gsap.set(".card", {
    transformPerspective: 1200,
    transformOrigin: "center center",
    transformStyle: "preserve-3d",
  });

  // ===== ðŸŽ¬ Main 3D Entrance Animation =====
  const cards = gsap.utils.toArray(".card");
  const tl = gsap.timeline({ defaults: { ease: "power3.out" } });

  cards.forEach((card, i) => {
    const fromLeft = i % 2 === 0; // alternate rotation direction
    tl.from(card, {
      opacity: 0,
      y: isMobile ? 30 : 50,
      rotateY: fromLeft ? -55 : 55,
      scale: 0.92,
      duration: 1.2,
      delay: i * 0.1,
      ease: "power3.out",
      clearProps: "transform",
    }, i * 0.1);
  });

  // ===== ðŸŒ«ï¸ Gentle Floating Effect =====
  gsap.utils.toArray(".card").forEach((card, i) => {
    gsap.to(card, {
      y: "+=3",
      duration: 3.5 + Math.random(),
      repeat: -1,
      yoyo: true,
      ease: "sine.inOut",
      delay: i * 0.2,
    });
  });

  // ===== ðŸŒŠ Sidebar & Header Smooth Entrance =====
  gsap.from(".sidebar, .dashboard-title, .header", {
    opacity: 0,
    x: -40,
    duration: 1,
    ease: "power2.out",
    delay: 0.3,
  });

    // ===== ðŸ–±ï¸ Hover Lift Effect =====
  if (!isMobile) {
    document.querySelectorAll(".card").forEach(card => {
      card.addEventListener("mouseenter", () => {
        gsap.to(card, {
          scale: 1.05,
          rotateY: 0,
          duration: 0.3,
          ease: "power2.out",
          boxShadow: "0 8px 25px rgba(0,0,0,0.18)",
        });
      });
      card.addEventListener("mouseleave", () => {
        gsap.to(card, {
          scale: 1,
          duration: 0.3,
          ease: "power2.inOut",
          boxShadow: "none",
        });
      });
    });
  }

  // ===== ðŸ‘‹ Greeting Animation =====
  gsap.from("#greeting", {
    opacity: 0,
    y: -25,
    duration: 1.1,
    ease: "back.out(1.6)",
  });




});
   

</script>

</head>
<body>

 <div class="dashboard-layout">



    <!-- LEFT SIDEBAR -->
    <aside class="sidebar">
      <h2>Expense Dashboard</h2>
      <nav>
        <ul>
          <li><a href="dashboard.html" >Overview</a></li>
          <li><a href="graph.html" class="active">Analytics</a></li>
          <li><a href="chatbot.html">Chatbot</a></li>
        </ul>
      </nav>
      <button id="logout-btn">Logout</button>
    </aside>








<div id="charts-section">
  <div class="card" id="lineCard"><div id="lineChart"></div></div>
  <div class="card" id="pieCard"><div id="pieChart"></div></div>

<div id="calendarCard" class="card">
  <div id="calendarControls">
    <button id="prevMonth">Previous</button>
    <span id="monthYear"></span>
    <button id="nextMonth">Next</button>
  </div>
  <div id="calendar"></div>
</div>



  <!-- D3 + Supabase + GSAP -->
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

  // âœ… Initialize Supabase Client
  const supabase = createClient('https://djnctdrtmfamvkidgwhx.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRqbmN0ZHJ0bWZhbXZraWRnd2h4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc5NDg2OTQsImV4cCI6MjA3MzUyNDY5NH0.Yf8155b0oxhDu62Otx9ZIqr9VV2NcHsZZ45SWJBXZY8')

  // âœ… Redirect if not logged in
const { data: { user } } = await supabase.auth.getUser();
if (!user) {
  window.location.href = 'index.html';
} else {
  const userId = user.id;

  // âœ… Logout button functionality
  document.getElementById('logout-btn').addEventListener('click', async () => {
    const { error } = await supabase.auth.signOut();
    if (error) return alert('Logout failed');
    window.location.href = 'index.html';
  });
}


    // âœ… Fetch transactions for logged-in user
    async function fetchUserTransactions(userId) {
      const { data, error } = await supabase
        .from('transactions')
        .select('category, expense, inserted_at')
        .eq('user_id', userId);

      if (error) {
        console.error('Error fetching transactions:', error);
        return [];
      }
      return data;
    }

    // âœ… Pie Chart
 async function createPieChart(userId) {
  const data = await fetchUserTransactions(userId);
  const grouped = d3.rollup(data, v => d3.sum(v, d => d.expense), d => d.category);
  const pieData = Array.from(grouped, ([category, total]) => ({ category, total }));

  const width = 300, height = 300, radius = Math.min(width, height) / 2;
  const svg = d3.select("#pieChart")
    .append("svg")
    .attr("width", width)
    .attr("height", height)
    .append("g")
    .attr("transform", `translate(${width / 2}, ${height / 2})`);

  const color = d3.scaleOrdinal(d3.schemeSet2);
  const pie = d3.pie().value(d => d.total);
  const arc = d3.arc().innerRadius(50).outerRadius(radius);

  const arcs = svg.selectAll("arc")
    .data(pie(pieData))
    .enter()
    .append("path")
    .attr("fill", d => color(d.data.category))
    .attr("d", arc);

  // Animate slices
  gsap.from(arcs.nodes(), {
    duration: 1.2,
    scale: 0,
    transformOrigin: "center",
    stagger: 0.2,
    ease: "back.out(1.7)"
  });

  // âœ… Legend
  const legend = d3.select("#pieChart")
    .append("div")
    .style("margin-top", "10px");

  pieData.forEach(d => {
    const item = legend.append("div").style("display", "flex").style("align-items", "center").style("margin-bottom", "4px");
    item.append("div")
      .style("width", "15px")
      .style("height", "15px")
      .style("background-color", color(d.category))
      .style("margin-right", "5px");
    item.append("span").text(d.category + ` (${d.total})`);
  });
}


    // âœ… Calendar Heatmap
 function createCalendar(transactions) {
  let currentDate = new Date(); // Current month
  const calendarDiv = d3.select("#calendar");

  function renderCalendar(date) {
    calendarDiv.html(""); // clear previous
    
    const month = date.getMonth();
    const year = date.getFullYear();
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);

    d3.select("#monthYear").text(`${firstDay.toLocaleString('default', { month: 'long' })} ${year}`);

     // Prepare daily totals for the month
    const dailyTotals = new Map();
    transactions.forEach(tx => {
      const txDate = new Date(tx.inserted_at);
      if (txDate.getMonth() === month && txDate.getFullYear() === year) {
        const dayStr = txDate.toISOString().split("T")[0];
        dailyTotals.set(dayStr, (dailyTotals.get(dayStr) || 0) + tx.expense);
      }
    });

 const color = d3.scaleSequential(d3.interpolateGreys)
  .domain([0, d3.max(Array.from(dailyTotals.values())) || 1]);


    const days = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
    const weeksInMonth = Math.ceil((firstDay.getDay() + lastDay.getDate()) / 7);
    const width = 700, cellSize = 60,height =  weeksInMonth * cellSize + 20 ;
    const svg = calendarDiv.append("svg").attr("width", width).attr("height", height);
    
    // Day labels
    days.forEach((d,i) => {
      svg.append("text")
        .attr("x", i*cellSize + 10)
        .attr("y", 15)
        .text(d)
        .style("font-size", "12px")
        .style("font-weight", "bold");
    });

    let x = firstDay.getDay() * cellSize;
    let y = 20;

    for (let d = 1; d <= lastDay.getDate(); d++) {
      const dayDate = new Date(year, month, d);
      const dayStr = dayDate.toISOString().split("T")[0];
      const total = dailyTotals.get(dayStr) || 0;

      svg.append("rect")
        .attr("x", x)
        .attr("y", y)
        .attr("width", cellSize - 2)
        .attr("height", cellSize - 2)
        .attr("rx", 4)
        .attr("fill", color(total));

      svg.append("title") // hover tooltip
        .text(`${dayStr}: ${total}`);

      svg.append("text") // date label
        .attr("x", x + 10)
        .attr("y", y + 20)
        .text(d)
        .style("font-size", "12px")
        .style("fill", total > 0 ? "#FFF" : "#000");
    // Total spent under the date
        svg.append("text")
        .attr("x", x + 5)
        .attr("y", y + 35)
        .text(total > 0 ? total.toFixed(2) : "")
        .style("font-size", "10px")
        .style("fill", total > 0 ? "#fff" : "#000");


      x += cellSize;
      if (dayDate.getDay() === 6) { // new row on Sunday
        x = 0;
        y += cellSize;
      }
    }

    // Animate
    gsap.from("rect", {
      opacity: 0,
      scale: 0,
      duration: 0.6,
      stagger: 0.03,
      ease: "elastic.out(1, 0.75)"
    });
  }

  // Initial render
  renderCalendar(currentDate);

  // Month navigation
  d3.select("#prevMonth").on("click", () => {
    currentDate.setMonth(currentDate.getMonth() - 1);
    renderCalendar(currentDate);
  });
  d3.select("#nextMonth").on("click", () => {
    currentDate.setMonth(currentDate.getMonth() + 1);
    renderCalendar(currentDate);
  });
}

    // âœ… Line Graph
   function createLineGraph(data) {
  data.sort((a, b) => new Date(a.inserted_at) - new Date(b.inserted_at));

  const width = 500, height = 300, margin = 50;

  const svg = d3.select("#lineChart")
    .append("svg")
    .attr("width", width)
    .attr("height", height);

  const x = d3.scaleTime()
    .domain(d3.extent(data, d => new Date(d.inserted_at)))
    .range([margin, width - margin]);

  const y = d3.scaleLinear()
    .domain([0, d3.max(data, d => d.expense)])
    .range([height - margin, margin]);

  // X axis
  svg.append("g")
    .attr("transform", `translate(0, ${height - margin})`)
    .call(d3.axisBottom(x).tickFormat(d3.timeFormat("%d-%b")))
    .append("text")
    .attr("x", width / 2)
    .attr("y", 40)
    .attr("fill", "black")
    .style("font-size", "12px")
    .style("text-anchor", "middle")
    .text("Date");

  // Y axis
  svg.append("g")
    .attr("transform", `translate(${margin}, 0)`)
    .call(d3.axisLeft(y))
    .append("text")
    .attr("transform", "rotate(-90)")
    .attr("x", -height / 2)
    .attr("y", -40)
    .attr("fill", "black")
    .style("font-size", "12px")
    .style("text-anchor", "middle")
    .text("Expense");

  // Line
  const line = d3.line()
    .x(d => x(new Date(d.inserted_at)))
    .y(d => y(d.expense))
    .curve(d3.curveMonotoneX);

  const path = svg.append("path")
    .datum(data)
    .attr("fill", "none")
    .attr("stroke", "black")
    .attr("stroke-width", 2)
    .attr("d", line);

  const totalLength = path.node().getTotalLength();
  path.attr("stroke-dasharray", totalLength).attr("stroke-dashoffset", totalLength);
  gsap.to(path.node(), { strokeDashoffset: 0, duration: 2, ease: "power2.out" });

  // Optional: add dots for each data point
  svg.selectAll("circle")
    .data(data)
    .enter()
    .append("circle")
    .attr("cx", d => x(new Date(d.inserted_at)))
    .attr("cy", d => y(d.expense))
    .attr("r", 4)
    .attr("fill", "white")
    .attr("stroke", "black")
    .attr("stroke-width", 1)
    .style("opacity", 0)
    .transition()
    .duration(1000)
    .style("opacity", 1);
}


    // âœ… Main Flow
    async function main() {
      const { data: { user } } = await supabase.auth.getUser();
      if (user?.id) {
        const transactions = await fetchUserTransactions(user.id);
        createPieChart(user.id);
        createLineGraph(transactions);
        createCalendar(transactions);
      } else {
        console.log("User not logged in");
      }
    }

    main();
  </script>
 </div>
</body>
</html>
